package collector

import (
	"bytes"
	"io"
	"os"
	"path/filepath"
	"sync/atomic"

	"github.com/andeya/pholcus/app/pipeline/collector/data"
	bytesSize "github.com/andeya/pholcus/common/bytes"
	"github.com/andeya/pholcus/common/closer"
	"github.com/andeya/pholcus/common/util"
	"github.com/andeya/pholcus/config"
	"github.com/andeya/pholcus/logs"
	// "github.com/andeya/pholcus/runtime/cache"
)

// outputFile writes a file cell to disk.
func (self *Collector) outputFile(file data.FileCell) {
	defer func() {
		data.PutFileCell(file)
		self.wait.Done()
	}()

	// Path format: file/"RuleName"/"time"/"Name"
	p, n := filepath.Split(filepath.Clean(file["Name"].(string)))
	// dir := filepath.Join(config.FILE_DIR, util.FileNameReplace(self.namespace())+"__"+cache.StartTime.Format("2006-01-02 15:04:05"), p)
	dir := filepath.Join(config.FILE_DIR, util.FileNameReplace(self.namespace()), p)

	fileName := filepath.Join(dir, util.FileNameReplace(n))

	// Create directory if needed
	d, err := os.Stat(dir)
	if err != nil || !d.IsDir() {
		if err := os.MkdirAll(dir, 0777); err != nil {
			logs.Log.Error(
				" *     Fail  [File download: %v | KEYIN: %v | Batch: %v]   %v [ERROR]  %v\n",
				self.Spider.GetName(), self.Spider.GetKeyin(), atomic.LoadUint64(&self.fileBatch), fileName, err,
			)
			return
		}
	}

	// Create file with 0777 if not exists, truncate if exists
	f, err := os.OpenFile(fileName, os.O_RDWR|os.O_CREATE|os.O_TRUNC, 0777)
	if err != nil {
		logs.Log.Error(
			" *     Fail  [File download: %v | KEYIN: %v | Batch: %v]   %v [ERROR]  %v\n",
			self.Spider.GetName(), self.Spider.GetKeyin(), atomic.LoadUint64(&self.fileBatch), fileName, err,
		)
		return
	}
	defer closer.LogClose(f, logs.Log.Error)

	size, err := io.Copy(f, bytes.NewReader(file["Bytes"].([]byte)))
	if err != nil {
		logs.Log.Error(
			" *     Fail  [File download: %v | KEYIN: %v | Batch: %v]   %v (%s) [ERROR]  %v\n",
			self.Spider.GetName(), self.Spider.GetKeyin(), atomic.LoadUint64(&self.fileBatch), fileName, bytesSize.Format(uint64(size)), err,
		)
		return
	}

	self.addFileSum(1)

	logs.Log.Informational(" * ")
	logs.Log.App(
		" *     [File download: %v | KEYIN: %v | Batch: %v]   %v (%s)\n",
		self.Spider.GetName(), self.Spider.GetKeyin(), atomic.LoadUint64(&self.fileBatch), fileName, bytesSize.Format(uint64(size)),
	)
	logs.Log.Informational(" * ")
}
